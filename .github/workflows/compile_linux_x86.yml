name: Compile main

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  run-tinystories:
    runs-on: ubuntu-20.04
    # runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.10
      - name: Print machine info
        run: |
          uname -a
      - name: Install requirements
        run: |
          pip install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/cpu
          pip install -r requirements.txt
      - name: Download checkpoints
        run: |
          mkdir -p checkpoints/stories15M
          pushd checkpoints/stories15M
          wget https://huggingface.co/karpathy/tinyllamas/resolve/main/stories15M.pt
          wget https://github.com/karpathy/llama2.c/raw/master/tokenizer.model
          popd
      - name: Run inference
        run: |          
          export MODEL_PATH=checkpoints/stories15M/stories15M.pt
          export MODEL_REPO=stories15M
          python generate.py --checkpoint_path ${MODEL_PATH} --temperature 0 --device cpu > ./output_eager
          cat./output_eager 
          python generate.py --compile --checkpoint_path ${MODEL_PATH} --temperature 0 --device cpu > ./output_compiled
          cat ./output_compiled
          python aoti_export.py --checkpoint_path ${MODEL_PATH} --output_path ./${MODEL_REPO}.so
          python generate.py --checkpoint_path ${MODEL_PATH} --temperature 0 --dso ./${MODEL_REPO}.so > ./output_aoti
          cat ./output_aoti
          # echo "******************************************"
          # echo "********* EAGER vs TORCH.COMPILE *********"
          # echo "******************************************"
          # diff output_eager output_compiled
          # echo "******************************************"
          # echo "********* EAGER vs AOT INDUCTOR  *********"
          # echo "******************************************"
          # diff output_eager output_aoti
